<!doctype html>
<html>
	<head>
	    <meta charset="utf-8">
	    <title>WebRTC Streaming Media from Files</title>
	    <script src="adapter.js"></script>
		<script src="/socket.io/socket.io.js"></script>
	</head>

	<body>
		<p>
			<input type="button" onclick="toggleMute();" value="Mute/Unmute"/>
			<input type="button" onclick="togglePlay();" value="Pause/Play"/>
			Volume:
			<input type="range" min="0" max="100" value="100" oninput="changeVolume(this);"/>
		</p>
		<input type="file" id="file"/>
		<br/>
		<input type="text" id="link" disabled/><input type="button" id="openLink" value="Open"/>
		<br/>
	</body>

    <script lang="javascript">
		// Check for the various File API support.
		if (window.File
			&& window.FileReader 
			&& window.FileList 
			&& window.Blob
			&& RTCPeerConnection
			&& (window.AudioContext || window.webkitAudioContext)) {
			document.getElementById('file').addEventListener('change', handleFileSelect, false);
			window.AudioContext = window.AudioContext || window.webkitAudioContext;
		} else {
			alert('The required APIs are not fully supported in this browser.');
		}

		var socket = io.connect();

		var context = new AudioContext();
		var currentStream;

		var pc_config = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};

		var peers = {};
		var myId;

		var gainNode = context.createGain();
		gainNode.connect(context.destination);
		var mediaSource, mediaBuffer, remoteDestination;
		var muted, start, stop;

		socket.on('your-id', function(id) {
			myId = id;
			console.log('id = ' + id);

			var clientURL = window.location.protocol + '//' + window.location.host + '/client.html?id=' + myId;
			document.getElementById('link').value = clientURL;
			document.getElementById('openLink').addEventListener('click', function(event) {
				var win = window.open(clientURL, '_blank');
				win.focus();
			}, false);
		});

		socket.on('disconnected', function(from) {
			peers[from] = undefined;
		});

		socket.on('logon', function(message) {
			pc = new RTCPeerConnection(pc_config);
			
			pc.onicecandidate = function(event) {
				socket.emit('message', { from: myId, to: message.from, data: { type: 'candidate', candidate: event.candidate } } );
			}

			peers[message.from] = { peerconnection: pc, stream: undefined };
			startPlayingIfPossible(message.from);
		});

		socket.on('message', function(message) {
			console.log('Received message: ' + JSON.stringify(message.data));

			if (message.data.type === 'candidate') {
				if (message.data.candidate) {
					peers[message.from].peerconnection.addIceCandidate(new RTCIceCandidate(message.data.candidate));
				}
			} else if (message.data.type === 'sdp') {
				peers[message.from].peerconnection.setRemoteDescription(new RTCSessionDescription(message.data.sdp));
			}
		});


		function startPlayingIfPossible(from) {
			// add the stream to the peerconnection for this connection
			if (mediaSource && remoteDestination) {
				peers[from].peerconnection.addStream(remoteDestination.stream);
				peers[from].stream = remoteDestination.stream;
				peers[from].peerconnection.createOffer(function(desc) {
					peers[from].peerconnection.setLocalDescription(desc);
					socket.emit('message', { from: myId, to: from, data: { type: 'sdp', sdp: desc } });
				}, failed);
			}
		}

		function failed(code) {
    		log("Failure callback: " + code);
  		}

    	function handleFileSelect(event) {
    		stopStream();

    		var file = document.getElementById('file').files[0];

    		if (file) {
    			if (file.type.match('audio*')) {
    				var reader = new FileReader();

    				reader.onload = (function(readEvent) {
    					context.decodeAudioData(readEvent.target.result, function(buffer) {
    						if (mediaSource) {
    							mediaSource.stop(0);
    						}

    						mediaBuffer = buffer;
							playStream();
							start = Date.now();
    					});
    				});

    				reader.readAsArrayBuffer(file);
    			}
    		}
    	}

    	function playStream(offset) {
    		offset = offset ? offset : 0;
			mediaSource = context.createBufferSource();
			mediaSource.buffer = mediaBuffer;
			mediaSource.start(0, offset / 1000);
			mediaSource.connect(gainNode);

			// setup remote stream
			remoteDestination = context.createMediaStreamDestination();
			mediaSource.connect(remoteDestination);

			for (var peer in peers) {
				startPlayingIfPossible(peer);
			}
    	}

    	function stopStream() {
    		for (var peer in peers) {
    			if (peers[peer].stream) {
	    			peers[peer].peerconnection.removeStream(peers[peer].stream);
	    			peers[peer].stream = undefined;
    			}
    		}

    		if (mediaSource) mediaSource.stop(0);
    	}

    	function changeVolume(element) {
    		var volume = element.value;
    		var fraction = parseInt(element.value, 10) / parseInt(element.max, 10);
    		gainNode.gain.value = fraction * fraction;
    	}

    	function toggleMute() {
    		if (muted) {
    			gainNode.gain.value = muted;
    			muted = undefined;
    		} else {
    			muted = gainNode.gain.value;
    			gainNode.gain.value = 0;
    		}
    	}

    	function togglePlay() {
    		if (stop) {
    			var offset = stop - start;
    			playStream(offset);
    			start = Date.now() - offset;
    			stop = undefined;
    		} else {
    			stopStream(offset);
    			stop = Date.now();
    		} 
    	}
    </script>

</html>