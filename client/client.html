<!doctype html>
<html>
	<head>
	    <meta charset="utf-8">
	    <title>WebRTC Streaming Media from Files</title>
   	    <script src="/js/adapter.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<link rel="shortcut icon" type="image/x-icon" href="http://www.tno.nl/favicon_tno.ico"/>
		<link rel="stylesheet" href="/res/tnortc.css" type="text/css"/>
		<style>
			#holder { border: 10px dashed #ccc; width: 300px; height: 300px; margin: 20px auto;}
			#holder.hover { border: 10px dashed #333; }
			#holder.background { background-size:100% 100%; background-repeat:no-repeat;}
		</style>
	</head>

	<body>
		<div id="blocktop">
			<span id="label99"/>
		</div>
		<div id="blockbanner-back">
			<div id="blockbanner"></div>
		</div>
		<div id="blockcontent">
			<article style="align: center;">
				<h1>Listen to the music</h1>

				<div style="text-align: center;">
					<h3 id='artist'/>
					<h3 id='title'/>
				</div>

				<div style="text-align: center;">
					<audio controls id="player" autoplay/>
						Your browser does not support the audio element.
					</audio>
				</div>
			</article>

		</div>
	</body>

    <script lang="javascript">
		var urlParams;
		(window.onpopstate = function () {
		    var match,
		        pl     = /\+/g,  // Regex for replacing addition symbol with a space
		        search = /([^&=]+)=?([^&]*)/g,
		        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
		        query  = window.location.search.substring(1);

		    urlParams = {};
		    while (match = search.exec(query))
		       urlParams[decode(match[1])] = decode(match[2]);
		})();

		var title = document.getElementById('title');
		var artist = document.getElementById('artist');

		if (RTCPeerConnection) {
		} else {
			alert('The required APIs are not fully supported in this browser.');
		}

		var pc_config = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};

		var socket = io.connect();

		var myId;
		var to = urlParams.id;

		socket.on('your-id', function(id) {
			myId = id;
			console.log('id = ' + id);
			socket.emit('logon', { from: myId, to: to } );
		});

		socket.on('error', function(message) {
			alert(message);
		});
	
		var pc = new RTCPeerConnection(pc_config, { optional: [ { RtpDataChannels: true } ]});

		var dataChannel = pc.createDataChannel('mediaDescription', { reliable: false });
		dataChannel.onmessage = function (event) {
			try {
				var mediaDescription = JSON.parse(event.data);
				title.innerHTML = mediaDescription.title;
				artist.innerHTML = mediaDescription.artist;
			} catch (err) {
				console.log(err);
			}
		}

		function updateMediaDescription() {
			console.log('media description received');
		}

		pc.onicecandidate = function(event) {
			socket.emit('message', { from: myId, to: to, data: { type: 'candidate', candidate: event.candidate } });
		}

		socket.on('message', function(message) {
			console.log('Received message: ' + JSON.stringify(message.data));
			
			if (message.data.type === 'candidate') {
				if (message.data.candidate) {
					pc.addIceCandidate(new RTCIceCandidate(message.data.candidate));
				}
			} else if (message.data.type === 'sdp') {
				pc.setRemoteDescription(new RTCSessionDescription(message.data.sdp));
				pc.createAnswer(function(desc) {
					pc.setLocalDescription(desc);
					socket.emit('message', { from: myId, to: message.from, data: { type: 'sdp', sdp: desc} } );
				}, failed);
			}
		});

	    pc.onaddstream = gotRemoteStream;

    	function gotRemoteStream(event) {
    		console.log('Got remote stream.');
    		var player = document.getElementById('player');
    		attachMediaStream(player, event.stream);
    		player.play();
    	}

   	  	function failed(code) {
	    	log("Failure callback: " + code);
  		}

    </script>

</html>