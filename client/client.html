<!doctype html>
<html>
	<head>
	    <meta charset="utf-8">
	    <title>WebRTC Streaming Media from Files</title>
   	    <script src="adapter.js"></script>
	    <script src="http://localhost:8000/socket.io/socket.io.js"></script>
	</head>

	<body>
		<audio controls id="player" autoplay>
			Your browser does not support the audio element.
		</audio>
	</body>

    <script lang="javascript">
		// Check for the various File API support.
		if (window.File
			&& window.FileReader 
			&& window.FileList 
			&& window.Blob
			&& RTCPeerConnection
			&& (window.AudioContext || window.webkitAudioContext)) {
		} else {
			alert('The required APIs are not fully supported in this browser.');
		}

		window.AudioContext = window.AudioContext || window.webkitAudioContext;

		var socket = io.connect('http://localhost:8000/client');

		var context = new AudioContext();

		var pc_config = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};
		var pc = new RTCPeerConnection(pc_config);

		pc.onicecandidate = function(event) {
			socket.emit('msg', { type: 'candidate', candidate: event.candidate });
		}

		socket.on('msg', function(data) {
			console.log('Received message: ' + JSON.stringify(data));
			
			if (data.type === 'candidate') {
				if (data.candidate) {
					pc.addIceCandidate(new RTCIceCandidate(data.candidate));
				}
			} else if (data.type === 'sdp') {
				pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
				pc.createAnswer(setLocalAndSendMessage, failed);
			}
		});

    	pc.onaddstream = gotRemoteStream;

    	function gotRemoteStream(event) {
    		console.log('Got remote stream.');
    		var player = new Audio();
    		//document.getElementById('player');
    		attachMediaStream(player, event.stream);
    		player.play();
    		// player.play();
			// var mediaStreamSource = context.createMediaStreamSource(event.stream);
			// mediaStreamSource.connect(context.destination);
    	}

    	function setLocalAndSendMessage(desc) {
			pc.setLocalDescription(desc);
			socket.emit('msg', { type: 'sdp', sdp: desc} );
    	}

    	function logEvent(event) {
    		console.log('Event received.');
    		console.log(event);
    	}

   	  	function failed(code) {
	    	log("Failure callback: " + code);
  		}

    </script>

</html>